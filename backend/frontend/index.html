<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Veg Quality AI</title>

<style>
:root {
  --bg: #f5f7fb;
  --card: #ffffff;
  --primary: #4f46e5;
  --primary-soft: #eef2ff;
  --border: #e5e7eb;
  --text: #111827;
  --muted: #6b7280;
  --success: #16a34a;
  --danger: #dc2626;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 24px;
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
}

h2 {
  margin: 0 0 12px;
  font-size: 18px;
}

.container {
  display: grid;
  grid-template-columns: 1.7fr 1fr;
  gap: 24px;
  align-items: start;
}

/* ---------- Cards ---------- */
.card {
  background: var(--card);
  border-radius: 16px;
  border: 1px solid var(--border);
  padding: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,.05);
}

/* ---------- Buttons ---------- */
button {
  background: var(--primary);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 14px;
  cursor: pointer;
}

button:hover {
  opacity: 0.9;
}

input[type="file"] {
  font-size: 14px;
}

/* ---------- Status ---------- */
#status {
  margin: 12px 0;
  padding: 10px 12px;
  border-radius: 10px;
  background: var(--primary-soft);
  color: var(--primary);
  font-size: 13px;
}

/* ---------- Video ---------- */
#frame {
  width: 100%;
  max-width: 720px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: #eef2f7;
}

/* ---------- Gallery ---------- */
#gallery {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  max-height: 360px;
  overflow-y: auto;
  padding-right: 4px;
}

#gallery img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 12px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.15s ease;
}

#gallery img:hover {
  transform: scale(1.02);
}

#gallery img.selected {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-soft);
}

/* ---------- Chat ---------- */
textarea {
  width: 100%;
  height: 90px;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid var(--border);
  resize: none;
  font-family: inherit;
}

pre {
  background: #f9fafb;
  border-radius: 12px;
  padding: 12px;
  border: 1px solid var(--border);
  font-size: 13px;
  white-space: pre-wrap;
}

/* ---------- Small helpers ---------- */
.row {
  display: flex;
  gap: 10px;
  align-items: center;
}

.muted {
  color: var(--muted);
  font-size: 13px;
}

@media (max-width: 900px) {
  .container {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<div class="container">

  <!-- LEFT -->
  <div class="card">
    <h2>Live Analysis</h2>

    <div class="row">
      <input type="file" id="file" accept="video/*" />
      <button id="start">Upload & Analyze</button>
    </div>

    <div id="status">Ready.</div>

    <img id="frame"
         src="https://placehold.co/720x405/e5e7eb/111827?text=Live+Preview"
         alt="Live analysis" />
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h2>Detected Crops</h2>
    <div id="gallery"></div>

    <hr style="margin:16px 0;border:none;border-top:1px solid var(--border);">

    <h2>AI Assistant</h2>
    <div class="muted">Selected: <b><span id="selectedName">none</span></b></div>

    <textarea id="q"
      placeholder="Ask: Can I eat this? How should I store it? What does rotten mean?">
    </textarea>

    <button id="ask" style="margin-top:10px;">Ask AI</button>

    <pre id="ans">Select a crop and ask a question.</pre>
  </div>

</div>

<script>
/* ===============================
   JS LOGIC (unchanged, safe)
================================ */
const API = `${location.protocol}//${location.host}`;
let selectedCrop = "";
let ws = null;
let cropPollTimer = null;

function setStatus(text) {
  document.getElementById("status").textContent = text;
}

async function refreshCrops() {
  try {
    const r = await fetch(`${API}/crops`, { cache: "no-store" });
    const data = await r.json();
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";

    if (!data.crops || data.crops.length === 0) {
      gallery.innerHTML = `<div class="muted">No crops detected yet.</div>`;
      return;
    }

    data.crops.forEach(url => {
      const img = document.createElement("img");
      img.src = API + url + `?t=${Date.now()}`;
      img.onclick = () => {
        document.querySelectorAll("#gallery img").forEach(i => i.classList.remove("selected"));
        img.classList.add("selected");
        selectedCrop = url;
        document.getElementById("selectedName").textContent =
          url.split("/").pop().replace(/_/g, " ");
      };
      gallery.appendChild(img);
    });
  } catch (e) {
    console.error(e);
  }
}

function connectWS(video_path) {
  if (ws) try { ws.close(); } catch {}

  const wsUrl =
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws/analyze";

  ws = new WebSocket(wsUrl);
  ws.binaryType = "arraybuffer";

  ws.onopen = () => {
    setStatus("Analyzing video…");
    ws.send(JSON.stringify({ video_path }));
    cropPollTimer = setInterval(refreshCrops, 2000);
  };

  ws.onmessage = (evt) => {
    if (typeof evt.data === "string") {
      try {
        const msg = JSON.parse(evt.data);
        if (msg.type === "new_crop") refreshCrops();
      } catch {}
      return;
    }
    const blob = new Blob([evt.data], { type: "image/jpeg" });
    const img = document.getElementById("frame");
    const url = URL.createObjectURL(blob);
    img.src = url;
    setTimeout(() => URL.revokeObjectURL(url), 200);
  };

  ws.onclose = () => {
    setStatus("Analysis finished.");
    clearInterval(cropPollTimer);
    refreshCrops();
  };
}

document.getElementById("start").onclick = async () => {
  const f = document.getElementById("file").files[0];
  if (!f) return alert("Choose a video first.");

  setStatus("Uploading video…");
  const form = new FormData();
  form.append("file", f);

  const up = await fetch(`${API}/upload`, { method: "POST", body: form });
  const { video_path } = await up.json();

  refreshCrops();
  connectWS(video_path);
};

document.getElementById("ask").onclick = async () => {
  const q = document.getElementById("q").value.trim();
  if (!selectedCrop) return alert("Select a crop image first.");
  if (!q) return alert("Type a question.");

  const ans = document.getElementById("ans");
  ans.textContent = "Thinking…";

  const r = await fetch(`${API}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ crop_url: selectedCrop, question: q })
  });
  const data = await r.json();
  ans.textContent = data.answer || "No response.";
};

refreshCrops();
</script>

</body>
</html>
